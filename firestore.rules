rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isGovernor() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'governor';
    }

    // SIMPLE RULE: IF LOGGED IN = YOU CAN DO IT

    match /users/{userId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
      match /twoFactorAuth/{doc} {
        allow read, write: if isAuthenticated();
      }
    }

    match /notifications/{notificationId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /loginActivity/{activityId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /deviceSessions/{sessionId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /twoFactor/{userId} {
      allow read, write: if isAuthenticated();
    }

    // COMMUNITY FEED - STUDENTS = GOVERNORS
    match /community_posts/{postId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /community_comments/{commentId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /community_reactions/{reactionId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /conversations/{conversationId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
      match /messages/{messageId} {
        allow read, list, create, update: if isAuthenticated();
        allow delete: if isGovernor();
      }
    }

    match /community_flags/{flagId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /messageReports/{reportId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /presence/{userId} {
      allow read, write: if isAuthenticated();
    }

    match /userPresence/{userId} {
      allow read, write: if isAuthenticated();
    }

    match /typingIndicators/{indicatorId} {
      allow read, write: if isAuthenticated();
    }

    // GROUP CHATS - STUDENTS = GOVERNORS
    match /groupChats/{groupId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
      match /messages/{messageId} {
        allow read, list, create, update: if isAuthenticated();
        allow delete: if isGovernor();
      }
    }

    match /courses/{courseId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
      match /modules/{moduleId} {
        allow read, list, write: if isAuthenticated();
        match /lessons/{lessonId} {
          allow read, list, write: if isAuthenticated();
        }
      }
    }

    match /modules/{moduleId} {
      allow read, list, write: if isAuthenticated();
    }

    match /main_modules/{moduleId} {
      allow read, list, write: if isAuthenticated();
    }

    match /submodules/{submoduleId} {
      allow read, list, write: if isAuthenticated();
    }

    match /aiTrainerSessions/{sessionId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /open_day_simulations/{simId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /open_day_answers/{answerId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /open_days/{openDayId} {
      allow read, list, write: if isAuthenticated();
    }

    match /recruiters/{recruiterId} {
      allow read, list, write: if isAuthenticated();
    }

    match /reports/{reportId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /bugReports/{reportId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /systemControl/{docId} {
      allow read: if true;
      allow write: if isGovernor();
    }

    match /systemSettings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /governorRoles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /governorCommands/{docId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /audit/{docId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /audit_logs/{logId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /auditLogs/{logId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /auditEvents/{eventId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /moderationAudit/{auditId} {
      allow read, list, write: if isAuthenticated();
    }

    match /moderation_logs/{logId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /supportTickets/{ticketId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
      match /messages/{messageId} {
        allow read, list, create, update: if isAuthenticated();
        allow delete: if isGovernor();
      }
    }

    match /user_module_progress/{progressId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /course_enrollments/{enrollmentId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /enrollments/{enrollmentId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /course_progress/{progressId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /video_progress/{progressId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /progress/{progressId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /userProgress/{userId}/modules/{moduleId} {
      allow read, write: if isAuthenticated();
      match /lessons/{lessonId} {
        allow read, write: if isAuthenticated();
      }
    }

    match /user_points/{userId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /point_events/{eventId} {
      allow read, list, create: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /exams/{examId} {
      allow read, list, write: if isAuthenticated();
    }

    match /userExams/{resultId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /quizResults/{resultId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /fcmTokens/{tokenId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /fileMetadata/{fileId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /storageQuota/{userId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /analyticsEvents/{eventId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /metrics/{metricId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /leaderboard/{scope} {
      allow read, list: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /messages/{messageId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /onboarding/{userId} {
      allow read, write: if isAuthenticated();
    }

    match /user_badges/{badgeId} {
      allow read, list, write: if isAuthenticated();
    }

    match /crew_declarations/{declarationId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /marketplace_products/{productId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /marketplace_orders/{orderId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /marketplace_favorites/{favoriteId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /marketplace_reviews/{reviewId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /marketplace_messages/{conversationId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /activities/{activityId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /activity_attendance/{attendanceId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /activity_streaks/{streakId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /user_streaks/{userId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /activity_galleries/{galleryId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /activity_registrations/{registrationId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /wallets/{walletId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /wallet_transactions/{transactionId} {
      allow read, list, create: if isAuthenticated();
      allow update, delete: if isGovernor();
    }

    match /referrals/{referralId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /affiliate_stats/{userId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /orders/{orderId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /communityPosts/{postId} {
      allow read, list, create, update, delete: if isAuthenticated();
    }

    match /updates/{updateId} {
      allow read, list: if isAuthenticated();
      allow create, update, delete: if isGovernor();
    }

    match /waitlist/{entryId} {
      allow create, read, list: if true;
      allow update, delete: if isGovernor();
    }

    match /staff_access_codes/{codeId} {
      allow get: if true;
      allow read, list, create, update, delete: if isGovernor();
    }

    match /user_reputation/{userId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /message_mentions/{mentionId} {
      allow read, list, create, update: if isAuthenticated();
      allow delete: if isGovernor();
    }

    match /stripe/{collection}/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    match /backups/{docId} {
      allow read: if isAuthenticated();
      allow write: if isGovernor();
    }

    match /{document=**} {
      allow read, write: if isGovernor();
    }
  }
}
